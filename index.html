<!DOCTYPE html>
<html>
  <head>
    <title>Boot2Gecko late-l10n triage</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/datatables/1.9.4/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="css/jquery-ui-1.9.2.custom.min.css" type="text/css">
    <script>
      var bzapi = "https://api-dev.bugzilla.mozilla.org/latest/";
      var product = "Boot2Gecko";
      var bugs = {}, history;
      var pending = 0;
      var lates = [], allbugs = [], fixed = [], nonfixed = [];
      var gdata = [];
      $.getJSON(bzapi + "bug", {
        product:product,
        keywords: "late-l10n",
        include_fields: "id,resolution,last_change_time,creation_time,cf_last_resolved,cf_blocking_basecamp,summary"
      }, onLoadBugs);
      function onLoadBugs(data) {
        // sort newest first
        var j, jj, id, bug;
        data.bugs.sort(function(bl, br) {
          if (bl.last_change_time < br.last_change_time) {
            return 1;
          }
          if (bl.last_change_time > br.last_change_time) {
            return -1;
          }
          return 0;
        })
        for (j=0, jj=Math.min(100, data.bugs.length); j<jj; ++j) {
          bug = data.bugs[j];
          id = bug.id;
          bug.creation_time = new Date(bug.creation_time);
          bug.last_change_time = new Date(bug.last_change_time);
          if (bug.cf_last_resolved) {
            bug.cf_last_resolved = new Date(bug.cf_last_resolved.split(" ", 1));
          }
          if (bug.resolution=="") bug.resolution="OPEN";
          bugs[id] = data.bugs[j];
          $.getJSON(bzapi + 'bug/' + id + '/history',
                    processHistory(id));
        }
      }
      function processHistory(id) {
        ++pending;
        return function(data) {
          history = data.history;
          var j, jj, k, kk, changes, change;
          for (j=data.history.length - 1; j >= 0; --j) {
            changes = data.history[j].changes;
            for (k = changes.length - 1; k >= 0; --k) {
              change = changes[k];
              if (change.field_name == 'keywords' && change.added == 'late-l10n') {
                bugs[id].late_l10n = new Date(data.history[j].change_time);
                maybeDoTable(id);
                return;
              }
            }
          }
          // we've had late-l10n from the start, use that
          bugs[id].late_l10n = bugs[id].creation_time;
          maybeDoTable(id);
        }
      }
      $(function () {
        $("#bugz").dataTable({
          "bJQueryUI": true,
          "bPaginate": false,
          "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
            var inner = $('<a></a>').attr('href', 'https://bugzilla.mozilla.org/show_bug.cgi?id=' + aData[0]).text(aData[0]);
            $('td:eq(0)', nRow).html(inner);
          }
        });
      });
      function maybeDoTable(id) {
        --pending;
        var tbl = [], bug = bugs[id];
        $("#bugz").dataTable().fnAddData([bug.id, bug.summary, bug.resolution, bug.cf_last_resolved, bug.creation_time, bug.late_l10n, bug.cf_blocking_basecamp]);
        lates.push(bug.late_l10n);
        allbugs.push(bug.creation_time);
        gdata.push({date: bug.creation_time, event:'creation', id: id});
        gdata.push({date: bug.late_l10n, event:'l10n', id: id});
        if (bug.cf_last_resolved) {
          gdata.push({date: bug.cf_last_resolved, event:bug.resolution=="FIXED" ? "fixed" : "nonfixed", id: id});
          if (bug.resolution=="FIXED") {
            fixed.push(bug.cf_last_resolved);
          }
          else {
            nonfixed.push(bug.cf_last_resolved);
          }
        }
        if (pending <= 0) {
          doD3();
        }
      }
    </script>
    <style>
      .axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
    </style>
  </head>
  <body>
    <h1>Boot2Gecko late-l10n triage</h1>
    <div id="burndown"></div>
    <table id='bugz' style='width:100%'>
      <thead>
        <tr>
          <th>Bug</th>
          <th>Summary</th>
          <th>Resolution</th>
          <th>Last FIXED</th>
          <th>Filed at</th>
          <th>late-l10n</th>
          <th>basecamp</th>
        </tr>
      </thead>
    </table>
    <script src="http://d3js.org/d3.v3.min.js" charset="UTF-8"></script>
    <script>
      var margin = {top: 20, right: 80, bottom: 30, left: 50},
      width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;
      
var x = d3.time.scale()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);
    
var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");
var yAxis2 = d3.svg.axis()
    .scale(y)
    .orient("right");

var line = d3.svg.line()
    .interpolate("step-after")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.count); });

var svg = d3.select("#burndown").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var data;
    function doD3() {
      lates.sort(d3.ascending); allbugs.sort(d3.ascending); fixed.sort(d3.ascending); nonfixed.sort(d3.ascending);
      gdata.sort(function(ld, rd) {return d3.ascending(ld.date, rd.date)});
      data = [
        {color: 'grey',
        "class": 'top_all',
        values: []},
        {color: 'black',
        "class": 'l10n',
        values: []},
        {color: 'red',
        "class": "open_l10n",
        values: []},
        {color: 'grey',
        "class": "non_fixed",
        values: []}
      ], fixed_=0;
      gdata.forEach(function(d) {
        switch (d.event) {
          case "creation":
            data[0].values.push({date:d.date, count:data[0].values.length+1-data[3].values.length})
            break;
          case "l10n":
            data[1].values.push({date:d.date, count:data[1].values.length-data[3].values.length+1})
            data[2].values.push({date:d.date, count:data[1].values.length-fixed_})
            break;
          case "nonfixed":
            data[3].values.push({date:d.date, count:-data[3].values.length-1})
            data[0].values.push({date:d.date, count:data[0].values.length-data[3].values.length})
            data[1].values.push({date:d.date, count:data[1].values.length-data[3].values.length})
          case "fixed":
            fixed_++;
            data[2].values.push({date:d.date, count:data[1].values.length-fixed_})
        }
      })
      var now = new Date();
      x.domain([allbugs[0], now]);
      y.domain([-nonfixed.length, allbugs.length]);
      data[0].values.push({date:now, count:data[0].values.length-data[3].values.length})
            data[1].values.push({date:now, count:data[1].values.length-data[3].values.length})
            data[2].values.push({date:now, count:data[1].values.length-fixed_})
            data[3].values.push({date:now, count:-data[3].values.length})
      
      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);
    
      svg.append("g")
          .attr("class", "y axis")
          .call(yAxis);
      svg.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(" + width + ",0)")
          .call(yAxis2);
      var bc = 0;
      var abg = svg.selectAll('.buggraph')
        .data(data)
        .enter()
        .append("g")
        .attr("class", "buggraph");
      
      abg.append("path")
        .attr("class", "line")
        .attr("d", function(d) { return line(d.values); })
        .style("stroke", function(d) { return d.color; });
    }
    </script>
  </body>
</html>